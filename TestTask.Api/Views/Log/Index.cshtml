@{
    ViewData["Title"] = "Logs Page";
}
<link
    rel="styleSheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-grid/4.8.1/ui-grid.min.css"
/>
<link
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
    rel="stylesheet"/>
<div
    ng-app="myApp"
    ng-controller="LogsController"
    class="p-5 d-flex flex-column gap-3"
>
    <div class="form-check form-switch">
        <input
            class="form-check-input"
            ng-model="isFiltersEnabled"
            ng-change="toggleFiltering()"
            type="checkbox"
            id="flexSwitchCheckDefault"
        >
        <label
            class="form-check-label"
            for="flexSwitchCheckDefault"
        >
            Toggle filters
        </label>
    </div>
    <div class="filters-container d-flex justify-content-start gap-4">
        <div class="date-filter-container d-flex gap-3">
            <div class="d-flex flex-column">
                <label for="dateFrom">Date from:</label>
                <div class="form-group d-flex gap-1">
                    <input
                        type="text"
                        id="dateFrom"
                        class="form-control date-filter"
                        style="width: 100px"
                        placeholder="dd.mm.yyyy"
                        ng-model="dateFrom"
                        ng-change="refreshLogs()" />
                    <button
                        type="button"
                        class="btn btn-danger btn-sm"
                        ng-click="clearFilter('dateFrom')">
                        X
                    </button>
                </div>
            </div>
            <div class="d-flex flex-column">
                <label for="dateTo">Date to:</label>
                <div class="d-flex gap-1">
                    <input
                        type="text"
                        id="dateTo"
                        class="form-control date-filter"
                        style="width: 100px"
                        placeholder="dd.mm.yyyy"
                        ng-model="dateTo"
                        ng-change="refreshLogs()"/>
                    <button
                        type="button"
                        class="btn btn-danger btn-sm"
                        ng-click="clearFilter('dateTo')">
                        X
                    </button>
                </div>
            </div>
        </div>
        <div class="entity-filter-container d-flex flex-column">
            <label for="entityType">Choose entity type</label>
            <div class="d-flex gap-1">
                <select class="form-select"
                        id="entityType"
                        ng-model="entityType"
                        ng-change="refreshLogs()"
                        ng-options="x for x in possibleEntityTypes">
                    <option value="" disabled>Choose type</option>
                </select>
                <button
                    type="button"
                    class="btn btn-danger btn-sm"
                    ng-click="clearFilter('entityType')">
                    X
                </button>
            </div>
        </div>
        <div class="user-filter-container d-flex flex-column">
            <label
                for="user">Input user name </label>
            <div class="d-flex gap-1">
                <input
                    type="text"
                    class="form-control"
                    id="user"
                    ng-model="user"
                    ng-change="refreshLogs()">
                <button
                    type="button"
                    class="btn btn-danger btn-sm"
                    ng-click="clearFilter('user')">
                    X
                </button>
            </div>
        </div>
    </div>
    <div
        class="grid"
        id="logsGrid"
        ui-grid="gridOptions"
        ui-grid-infinite-scroll
        ui-grid-resize-columns
        ui-grid-move-columns
    >
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-grid/4.8.1/ui-grid.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script>
    let myApp = angular.module('myApp',
        [
            'ui.grid',
            'ui.grid.infiniteScroll',
            'ui.grid.resizeColumns',
            'ui.grid.moveColumns'
        ]);

    myApp.controller('LogsController', function ($http, $scope) {
        $scope.page = 1;
        $scope.pageSize = 20;
        $scope.items = [];
        $scope.isFiltersEnabled = true;
        $scope.dateFrom = '';
        $scope.dateTo = '';
        $scope.entityType = null;
        $scope.possibleEntityTypes = [];
        $scope.user = '';
        let isLoading = false;

        $scope.gridOptions = {
            data: 'items',
            enableFiltering: $scope.isFiltersEnabled,
            enableColumnResizing: true,
            infiniteScrollRowsFromEnd: 20,
            infiniteScrollDown: true,
            onRegisterApi: function (gridApi) {
                gridApi.infiniteScroll.on.needLoadMoreData($scope, $scope.loadMoreLogs);
                $scope.gridApi = gridApi;
            }
        };

        $scope.getLogs = (page, pageSize, dateFrom, dateTo, entityType, user) => {
            return $http.get('Log/Get', {
                params: {
                    page, pageSize,
                    dateFrom, dateTo,
                    entityType, user
                }
            })
                .then(response => response.data.logs);
        }

        const loadLogs = (append) => {
            if (isLoading) return;
            isLoading = true;

            const pageToFetch = append ? $scope.page : 1;

            $scope.getLogs(
                pageToFetch, $scope.pageSize,
                $scope.dateFrom, $scope.dateTo,
                $scope.entityType, $scope.user
            )
                .then(logs => {
                    if (append) {
                        $scope.items = $scope.items.concat(logs);
                        $scope.page++;
                    } else {
                        $scope.items = logs;
                        $scope.page = 2;
                    }

                    if (logs.length < $scope.pageSize)
                        $scope.gridApi.infiniteScroll.dataLoaded(true);
                    else
                        $scope.gridApi.infiniteScroll.dataLoaded(false);

                    updateFilters();
                })
                .catch(error => {
                    console.error('Ошибка:', error)
                    $scope.gridApi.infiniteScroll.dataLoaded(true)
                })
                .finally(() => {
                    isLoading = false;
                })
        }

        $scope.refreshLogs = () => loadLogs(false);
        $scope.loadMoreLogs = () => loadLogs(true);

        $scope.toggleFiltering = () => {
            $scope.gridOptions.enableFiltering = $scope.isFiltersEnabled;

            $scope.gridOptions.columnDefs.forEach(col => {
                col.enableFiltering = $scope.isFiltersEnabled;
            });

            $scope.gridApi.core.notifyDataChange('column');
        };

        const updateFilters = () => {
            const newEntityItems = Array.from(new Set($scope.items.map(item => item.entity)));
            if (newEntityItems.length > $scope.possibleEntityTypes)
                $scope.possibleEntityTypes = newEntityItems;
        }

        $scope.clearFilter = (name) => {
            $scope[name] = '';
            $scope.refreshLogs();
        }

        $(document).ready(() => {
            $('.date-filter').datepicker({
                format: 'yyyy-mm-dd',
                autoclose: true,
                todayHighlight: true,
                language: 'ru'
            });

            $scope.refreshLogs()
        });
    })
</script>
